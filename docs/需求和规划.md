# docConverter 项目需求与规划文档

## 1. 项目目标

创建一个本地运行的**带有图形用户界面 (GUI) 的桌面应用程序** (`docConverter`)，用于将特定格式的 Word 文档 (`.docx`) 中的表格数据转换为 CSV 文件。该 CSV 文件旨在方便地导入到 `@LDIMS` 项目的 `documents` 数据库表中。此工具应独立运行，不依赖外部数据库或网络连接。

## 2. 核心需求

### 2.1 输入

*   **Word 文档选择:** 用户通过图形界面中的文件选择对话框选择一个 `.docx` 文件。
*   **目标 CSV 文件选择:** 用户通过图形界面中的文件选择对话框**选择或指定一个目标 CSV 文件路径**。这个文件将用于保存转换结果（新创建或追加）。
*   **表格结构:** 输入的 Word 文档**可能包含一个或多个表格**。工具将**查找并处理文档中所有**符合以下列结构规范的表格。
    *   **匹配标准:** 基于表格的第一行（表头）进行判断。
        *   忽略表头单元格内容的前后空格。
        *   忽略表头单元格内容的大小写。
        *   **必须**包含与基准表头（`序号`, `资料名称`, `资料来源`, `提交人`, `接收人`, `交接日期`, `存放位置`, `备注`）对应的所有列，且**顺序完全一致**。
    *   基准表头列：
        *   序号
        *   资料名称
        *   资料来源
        *   提交人
        *   接收人
        *   交接日期
        *   存放位置
        *   备注

### 2.2 处理流程

1.  **获取输入:** 用户选择源 Word 文档和目标 CSV 文件。
2.  **读取 Word 表格:** 解析用户选定的 `.docx` 文件，遍历文档中的所有表格，检查表头，提取所有匹配表格的数据行。
3.  **处理目标 CSV 文件:**
    *   **检查存在性:** 检查用户指定的目标 CSV 文件是否存在。
    *   **若不存在:** 创建该 CSV 文件，并**写入预定义的表头行**。
    *   **若存在:** 以**追加模式**打开文件。
        *   **表头校验:** 读取现有 CSV 文件的第一行（表头）。**比较时忽略前后空格和大小写，但要求列名和顺序与预定义 CSV 表头完全一致**。
        *   **如果表头不匹配:** 向用户显示错误信息（例如："目标 CSV 文件表头与预期格式不符，无法追加"），并**中止**当前转换操作。
        *   **如果表头匹配:** 继续执行，准备追加数据行（**不再写入表头**）。
4.  **数据映射与转换 (逐行处理):**
    *   对从所有匹配 Word 表格中提取的**每一行数据**进行处理。
    *   **错误捕获**: 在处理单行数据时，捕获可能发生的错误。
    *   **列映射关系 (Word -> CSV):** (如果行数据有效)
        *   `资料名称` -> `文档名称`
        *   `资料来源` -> `来源部门`
        *   `提交人` -> `提交人`
        *   `接收人` -> `接收人`
        *   `存放位置` -> `保管位置`
        *   `备注` -> `备注`
    *   **日期格式转换:** (如果行数据有效且日期格式可解析)
        *   Word 表格中的 `交接日期` 列数据需要进行格式转换。**工具将尝试解析以下常见格式**（优先顺序未定，建议按出现频率尝试）：`YY.MM.DD`, `YYYY.MM.DD`, `YYYY/MM/DD`, `YYYY-MM-DD`。
        *   **如果单元格内容无法匹配以上任何格式，则视为转换错误**，记录到错误日志。
        *   成功解析后，统一转换为 `'YYYY-MM-DD'` 格式，并填入 CSV 的 `交接日期` 列。
        *   假设两位年份 (`YY`) 均指 21 世纪（即 `24` 对应 `2024`）。
    *   **忽略与留空处理:**
        *   Word 表格中的 "序号" 列将被**忽略**。
        *   以下 CSV 列由于在源 Word 表格中无对应数据，将**保持为空**: `文档 ID`, `文档类型`, `签收(章)人`, `创建人`, `创建时间`, `最后修改人`, `最后修改时间`。
    *   **错误记录**: 如果单行数据处理失败，**将该行原始数据（尽可能包含表格索引和行号）及错误原因记录到错误日志文件中**，并跳过该行，继续处理下一行。
5.  **写入 CSV 数据:** 将所有**成功转换**的数据行**写入（或追加）**到目标 CSV 文件中。

### 2.3 输出

*   **目标 CSV 文件:**
    *   如果目标文件原先不存在，则生成一个包含表头和本次转换成功数据的 CSV 文件。
    *   如果目标文件已存在且表头匹配，则将本次转换成功的数据**追加**到该文件末尾。
*   **表头 (Header):** CSV 文件的第一行必须**精确包含**以下列名，并**严格按照此顺序**排列：
    `文档 ID`,`文档名称`,`文档类型`,`来源部门`,`提交人`,`接收人`,`签收(章)人`,`交接日期`,`保管位置`,`备注`,`创建人`,`创建时间`,`最后修改人`,`最后修改时间`
*   **数据行:** 表头下方为合并后的**成功转换的**数据行，每行对应 Word 表格中的一条记录（来自所有匹配的表格），数据按照新的表头顺序排列，以逗号分隔。对于无对应源数据的列，该字段留空。
*   **错误日志文件:**
    *   如果转换过程中出现任何行级错误，则生成一个 `.log` 文件（例如 `docConverter_error.log`），默认与输出的 CSV 文件放在同一目录。
    *   日志文件记录所有处理失败的行的详细信息，包括：时间戳、错误描述、原始行数据（或关键字段）、来源表格索引和行号（如果可能获取）。
    *   建议采用追加模式写入日志，以便保留多次运行的错误记录。
*   **编码:** CSV 文件和日志文件都必须使用 UTF-8 编码。
*   **文件名与位置:**
    *   **目标 CSV 文件:** 由用户指定路径和名称。
    *   **错误日志文件:** 默认生成在**与目标 CSV 文件相同的目录下**，文件名可固定（如 `docConverter_error.log`）或与目标 CSV 文件关联（如 `[target_csv_name]_error.log`）。
*   **用户反馈:**
    *   转换完成后，在 GUI 界面上显示成功信息（例如："成功创建并写入 X 行数据到 [目标 CSV 文件路径]" 或 "成功追加 Y 行数据到 [目标 CSV 文件路径]"）以及 CSV 文件路径。
    *   **如果生成了错误日志文件**，还应显示失败的行数，提示用户查看错误日志，并提供一个**直接打开错误日志文件的按钮**。
*   **快捷打开:** 提供按钮允许用户打开**目标 CSV 文件**、**目标 CSV 文件所在的文件夹**、以及**错误日志文件（如果存在）**。

## 3. 技术选型

*   **编程语言:** Python 3.x
*   **核心库:**
    *   `python-docx`: 用于读取 `.docx` 文件内容和表格。
    *   `csv`: Python 内置库，用于写入 CSV 文件。
    *   `datetime`: Python 内置库，用于处理日期转换。
    *   `tkinter`: Python 内置标准 GUI 库，用于构建图形用户界面 (包括文件选择对话框)。
    *   `os` / `subprocess`: Python 内置库，用于实现"打开文件/文件夹"的功能。
    *   `logging`: Python 内置库，用于记录错误日志。
    *   **`threading`**: Python 内置库，用于将耗时操作（如文件处理）放到后台线程执行，保持 GUI 响应。
*   **运行方式:** **图形用户界面 (GUI) 应用程序**。

## 4. 实现步骤规划

1.  **环境搭建:** 创建 Python 虚拟环境，安装 `python-docx` 库。**创建并维护 `requirements.txt` 文件**，列出项目依赖（如 `python-docx`）。
2.  **日志配置:** 配置 `logging` 模块，设定日志格式、级别、输出文件和写入模式（例如追加）。
3.  **GUI 布局设计:**
    *   设计主窗口布局，包含：
        *   文件选择按钮（用于 Word）。
        *   显示已选 Word 文件路径的标签。
        *   **目标 CSV 文件选择按钮。**
        *   **显示目标 CSV 文件路径的标签。**
        *   转换按钮。
        *   **状态/结果显示区域 (应能显示处理中状态)。**
        *   打开目标 CSV 文件/文件夹的按钮。
        *   打开错误日志文件的按钮（初始可隐藏）。
4.  **GUI 界面实现 (使用 Tkinter):**
    *   创建主窗口。
    *   添加控件（按钮、标签、文本框/标签用于显示信息）。
    *   实现文件选择按钮的功能，调用文件对话框让用户选择 `.docx` 文件，并将路径显示在界面上。
    *   **实现目标 CSV 文件选择按钮的功能。**
5.  **集成核心转换逻辑:**
    *   将 Word 读取、目标 CSV 处理、单行转换、数据写入/追加逻辑封装成**可在后台线程运行**的函数。
    *   将"转换"按钮与**启动后台线程执行该函数**的逻辑绑定。**在线程执行期间，更新 GUI 显示为"处理中..."状态。线程结束后，根据结果更新 GUI 反馈信息。**
6.  **实现 Word 文件读取与表格遍历:** (需要实现**细化的表头匹配逻辑**)
7.  **实现表格数据提取与单行处理:**
    *   编写逻辑从匹配的表格中逐行提取数据。
    *   **在循环内部实现对每一行数据的转换尝试，并包含 `try...except` 块来捕获预期的错误（如日期格式错误）。**
    *   **在 `except` 块中，调用日志记录函数记录错误详情。**
8.  **实现数据转换:** (逻辑同前，但在单行处理的 `try` 块内)
9.  **实现 CSV 文件写入/追加:**
    *   **根据目标文件是否存在以及表头校验结果，选择创建写入或追加写入模式。**
    *   只写入/追加成功转换的行。
10. **结果反馈与文件打开:**
    *   **更新 GUI 结果显示，区分创建和追加两种情况。**
    *   实现"打开文件"按钮的功能，使用 `os` 或 `subprocess` 模块调用系统命令打开生成的 CSV 文件。
    *   实现"打开文件夹"按钮的功能，打开 CSV 文件所在的目录。
    *   **实现"打开日志"按钮的功能，打开错误日志文件。**
11. **错误处理:**
    *   **除了行级错误记录到日志**，还需要处理全局性错误（如文件无法读取、无匹配表格、**目标 CSV 表头不匹配**等），并在 GUI 中清晰显示。
12. **测试:** 准备包含有效和无效数据（错误日期格式、非预期列数行等）的 Word 测试文档，测试 GUI 交互、核心转换功能、**错误日志记录的准确性**和文件打开功能。
13. **打包 (可选):** 使用 PyInstaller 或类似工具将 Python 脚本打包成可执行文件，方便分发。
14. **文档完善:** 补充代码注释和简单的使用说明 (`README.md`)，**说明错误日志文件的作用和位置**。

## 5. 非功能性需求

*   **易用性:** **图形界面直观、简洁，操作流程符合用户习惯。**
*   **健壮性:** 能处理常见的错误情况并在界面上给出清晰的用户提示。
*   **性能:** 对于常规大小的 Word 文件，处理过程不应导致界面长时间无响应（**通过后台线程处理实现**）。
*   **平台兼容性:** 尽量确保在主流桌面操作系统（Windows, macOS, Linux）上运行。Tkinter 具有良好的跨平台性。
*   **外观:** 界面美观度要求不高，但应保持整洁。

## 6. 未来可能的扩展 (可选)

*   支持处理 Word 文档中的多个表格 (可能需要在 GUI 中让用户选择)。
*   支持更多输入格式 (如 `.doc`, Excel `.xlsx`) (需要在 GUI 中增加选项或自动判断)。
*   提供更详细的转换进度显示 (例如，通过后台线程更新处理的行数)。
*   更灵活的列映射配置 (通过 GUI 界面)。
*   支持批量转换。 