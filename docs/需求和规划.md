# docConverter 项目需求与规划文档

## 1. 项目目标

创建一个本地运行的**带有图形用户界面 (GUI) 的桌面应用程序** (`docConverter`)，用于将特定格式的 Word 文档 (`.docx`) 中的表格数据转换为 **Excel 文件 (`.xlsx`)**。该 Excel 文件旨在方便地导入到 `@LDIMS` 项目的 `documents` 数据库表中（**以用户提供的、可成功导入的 `1.xlsx` 文件为最终格式标准**）。此工具应独立运行，不依赖外部数据库或网络连接。

## 2. 核心需求

### 2.1 输入

*   **Word 文档选择:** 用户通过图形界面中的文件选择对话框选择一个 `.docx` 文件。
*   **目标 Excel 文件选择:** 用户通过图形界面中的文件选择对话框**选择或指定一个目标 Excel 文件路径 (`.xlsx`)**。这个文件将用于保存转换结果（新创建或追加）。
*   **表格结构:** 输入的 Word 文档**可能包含一个或多个表格**。工具将**查找并处理文档中所有**符合以下列结构规范的表格。
    *   **Word 表头匹配标准:** 基于表格的第一行（表头）进行判断。
        *   **移除**表头单元格内容的所有空格（包括内部、首尾、全角空格）。
        *   **忽略**表头单元格内容的大小写。
        *   标准化后的表头**必须**包含与基准表头（`序号`, `资料名称`, `资料来源`, `提交人`, `接收人`, `交接日期`, `存放位置`, `备注`）对应的所有列，且**顺序完全一致**。
    *   基准 Word 表头列：
        *   序号
        *   资料名称
        *   资料来源
        *   提交人
        *   接收人
        *   交接日期
        *   存放位置
        *   备注

### 2.2 处理流程

1.  **获取输入:** 用户选择源 Word 文档和目标 Excel 文件。
2.  **读取 Word 表格:** 解析用户选定的 `.docx` 文件，遍历文档中的所有表格，根据上述 Word 表头匹配标准检查表头，提取所有匹配表格的数据行。
3.  **处理目标 Excel 文件:**
    *   **检查存在性:** 检查用户指定的目标 Excel 文件是否存在。
    *   **若不存在:** 创建该 Excel 文件，并在第一个工作表中**写入预定义的 Excel 表头行** (`EXPECTED_EXCEL_HEADERS`)。
    *   **若存在:** 以**追加模式**打开文件。
        *   **Excel 表头校验:** 读取现有 Excel 文件活动工作表的第一行（表头）。**进行精确比较 (Exact Match)**，要求读取到的表头列表**必须**与代码中定义的 `EXPECTED_EXCEL_HEADERS` **完全一致**（包括字符、空格和顺序）。
        *   **如果表头不匹配:** 在 GUI 中显示错误信息（例如："目标 Excel 文件表头与预期格式不符，无法追加"），并**中止**当前转换操作。
        *   **如果表头匹配:** 继续执行，准备向活动工作表追加数据行（**不再写入表头**）。
4.  **数据映射与转换 (逐行处理):**
    *   对从所有匹配 Word 表格中提取的**每一行非空数据** (`_extract_data_from_table` 已跳过完全空行) 进行处理。
    *   **错误捕获**: 在处理单行数据时，捕获可能发生的错误 (如 `_process_row` 返回 `None`)。
    *   **列映射关系 (Word -> Excel):**
        *   `资料名称` -> `文档名称` (列 1)
        *   `资料来源` -> `来源部门` (列 3)
        *   `提交人` -> `提交人` (列 4)
        *   `接收人` -> `接收人` (列 5)
        *   `交接日期` -> `交接日期` (列 7)
        *   `存放位置` -> `保管位置` (列 8)
        *   `备注` -> `备注` (列 9)
    *   **日期格式转换:**
        *   Word 表格中的 `交接日期` 列数据需要进行格式转换。工具尝试解析多种常见格式。
        *   **如果单元格内容无法匹配任何预设格式，则记录警告**，该行的对应 Excel 日期单元格留空。
        *   成功解析后，统一转换为 `'YYYY-MM-DD'` 格式。
    *   **忽略与留空处理:**
        *   Word 表格中的 "序号" 列将被**忽略**。
        *   以下 Excel 列由于在源 Word 表格中无对应数据，将**保持为空**: `文档 ID` (列 0), `文档类型` (列 2), `签收(章)人` (列 6), `创建人` (列 10), `创建时间` (列 11), `最后修改人` (列 12), `最后修改时间` (列 13)。
    *   **处理后空行跳过**: **即使原始 Word 行有内容，如果在 `_process_row` 处理后，生成的 `excel_row` 列表所有元素都为空字符串，则该行也会被跳过**，不写入 Excel，并计入"跳过处理后空行"的计数。
    *   **错误记录**: 如果单行数据处理失败 (例如 `_process_row` 返回 `None` 或发生意外异常)，将该行处理计为错误，**记录到日志文件中**，并跳过该行，继续处理下一行。
5.  **写入 Excel 数据:** 将所有**成功转换且处理后非空**的数据行**写入（或追加）**到目标 Excel 文件的活动工作表中。

### 2.3 输出

*   **目标 Excel 文件 (`.xlsx`):**
    *   如果目标文件原先不存在，则生成一个包含表头和本次转换成功数据的 Excel 文件。
    *   如果目标文件已存在且表头匹配，则将本次转换成功的数据**追加**到该文件活动工作表的末尾。
*   **表头 (Header):** Excel 文件活动工作表的第一行必须**精确包含**以下列名，并**严格按照此顺序**排列 (基于用户确认的标准 `1.xlsx` 文件)：
    `文档 ID`,`文档名称`,`文档类型`,`来源部门`,`提交人`,`接收人`,`签收(章)人`,`交接日期`,`保管位置`,`备注`,`创建人`,`创建时间`,`最后修改人`,`最后修改时间`
*   **数据行:** 表头下方为合并后的**成功转换且处理后非空**的数据行，每行对应 Word 表格中的一条记录（来自所有匹配的表格），数据按照新的表头顺序排列。对于无对应源数据的列，该字段留空。
*   **日志文件 (`.log`):**
    *   **每次**转换操作都会生成或更新一个 `.log` 文件。
    *   日志文件记录转换过程的详细信息，包括：开始/结束时间、处理的表格数、成功行数、失败行数、读取时跳过的空行数、处理后跳过的空行数、遇到的错误详情（包括行数据、来源、错误原因）等。
    *   采用**追加模式**写入日志。
*   **编码:** Excel 文件由 `openpyxl` 处理（通常兼容 UTF-8）。日志文件明确使用 UTF-8 编码。
*   **文件名与位置:**
    *   **目标 Excel 文件:** 由用户指定路径和名称。
    *   **日志文件:** 生成在**与目标 Excel 文件相同的目录下**，文件名与目标 Excel 文件关联（例如，如果目标是 `result.xlsx`，日志是 `result_conversion.log`）。
*   **用户反馈 (GUI):**
    *   转换完成后，在 GUI 主界面的**多行文本区域**显示最终状态信息，**不再使用弹窗**。
    *   状态信息包含摘要（如 "转换完成"）、成功行数、失败行数、以及**总的跳过空行数**（合并了读取时跳过和处理后跳过两种情况）。
    *   **不显示**日志文件的具体路径。
*   **快捷打开:** GUI 提供按钮允许用户：
    *   打开**目标 Excel 文件**。
    *   打开**目标 Excel 文件所在的文件夹**。
    *   打开**本次转换生成的日志文件**（按钮在日志文件存在时启用）。

## 3. 技术选型

*   **编程语言:** Python 3.x
*   **核心库:**
    *   `python-docx`: 用于读取 `.docx` 文件内容和表格。
    *   **`openpyxl`**: 用于写入/读取 Excel (`.xlsx`) 文件。
    *   `datetime`: Python 内置库，用于处理日期转换。
    *   `tkinter` (包括 `tkinter.ttk`, `tkinter.filedialog`, `tkinter.messagebox`, `tkinter.scrolledtext`): Python 内置标准 GUI 库。
    *   `os`: Python 内置库，用于路径操作和启动文件/文件夹 (via `os.startfile`)。
    *   `webbrowser`: Python 内置库，作为 `os.startfile` 不可用时的备选打开方式。
    *   `logging`: Python 内置库，用于记录详细日志。
    *   `threading`: Python 内置库，用于后台处理。
*   **运行方式:** **图形用户界面 (GUI) 应用程序**。

## 4. 实现步骤规划 (已大致完成，反映当前状态)

1.  **环境搭建:** 创建虚拟环境，安装 `python-docx`, `openpyxl`。创建 `requirements.txt`。
2.  **日志配置:** 配置 `logging`，输出到与 Excel 同目录的文件，追加模式。
3.  **GUI 布局设计与实现 (Tkinter):**
    *   创建主窗口 (可调整大小)。
    *   实现 Word 和 Excel 文件选择控件。
    *   实现转换按钮。
    *   **使用 `scrolledtext` 作为状态/结果显示区域。**
    *   实现底部三个按钮："打开 Excel", "打开所在文件夹", "打开日志"。
4.  **实现核心转换逻辑 (`converter.py`):**
    *   `DocConverter` 类初始化。
    *   `_setup_logger`: 配置日志。
    *   `_check_word_table_header`: 实现 Word 表头匹配 (忽略大小写，移除所有空格)。
    *   `_check_excel_header`: 实现 Excel 表头检查 (存在则精确匹配 `EXPECTED_EXCEL_HEADERS`)。
    *   `_extract_data_from_table`: 提取数据，跳过完全空行并计数。
    *   `_process_row`: 映射数据，处理日期，处理留空列。
    *   `convert`:  orchestrate 流程，调用上述方法，处理文件创建/追加，**检查处理后空行并计数**，捕获异常，返回包含所有计数的结果字典。
5.  **GUI 与核心逻辑集成 (`gui.py`):**
    *   将转换操作放到后台线程 (`threading`) 执行。
    *   在线程中调用 `converter.convert()`。
    *   转换开始时禁用按钮，更新状态区为"处理中"。
    *   转换结束后 (`_update_gui_post_conversion`)：
        *   从结果字典获取计数。
        *   **格式化包含所有计数的状态信息，更新 `scrolledtext` 区域。**
        *   **移除所有 `messagebox` 弹窗。**
        *   根据结果和文件存在性启用底部按钮。
    *   **实现三个"打开"按钮的功能 (`_open_generic`, `_open_excel`, `_open_folder`, `_open_log`)，使用 `os.startfile` / `webbrowser.open`。**
6.  **工具函数 (`utils.py`):** 实现 `normalize_header` (移除所有空格) 和 `parse_date`。
7.  **主入口 (`main.py`):** 初始化 Tkinter root 和 App 类，启动 GUI。
8.  **测试:** 使用不同 Word 文件（多表格、含空格表头、空行、错误日期）测试转换、Excel 输出、状态反馈、按钮功能和日志记录。
9.  **打包 (可选):** 使用 PyInstaller 等。
10. **文档完善:** 更新 `README.md` 和代码注释。

## 5. 非功能性需求

*   **易用性:** GUI 直观简洁。
*   **健壮性:** 处理常见错误，GUI 清晰提示（在状态区）。
*   **性能:** 后台线程处理，GUI 保持响应。
*   **平台兼容性:** Tkinter, `os.startfile`/`webbrowser` 提供基础跨平台能力。
*   **外观:** 整洁。

## 6. 未来可能的扩展

*   支持处理 Word 文档中的多个表格 (可能需要在 GUI 中让用户选择)。
*   支持更多输入格式 (如 `.doc`, Excel `.xlsx`) (需要在 GUI 中增加选项或自动判断)。
*   提供更详细的转换进度显示 (例如，通过后台线程更新处理的行数)。
*   更灵活的列映射配置 (通过 GUI 界面)。
*   支持批量转换。 